---
import Layout from "../layouts/Layout.astro";
---

<Layout title="MCP Test">
  <h1 style="text-align: center; margin-bottom: 2rem;">MCP Connection Test</h1>

  <div style="max-width: 600px; margin: 0 auto;">
    <div style="margin-bottom: 2rem;">
      <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Test Search Catalog</h2>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <input
          type="text"
          id="searchQuery"
          placeholder="Enter search query (e.g., 'blue shirt')"
          value="blue shirt"
          style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
        />
        <button
          id="searchBtn"
          style="padding: 0.5rem 1rem; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer;"
        >
          Search
        </button>
      </div>
      <div
        id="results"
        style="padding: 1rem; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; min-height: 100px; white-space: pre-wrap; font-family: monospace; font-size: 0.875rem;"
      >
        Click "Search" to test MCP connection...
      </div>
    </div>

    <div style="margin-bottom: 2rem;">
      <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Environment Status</h2>
      <div
        id="envStatus"
        style="padding: 1rem; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.875rem;"
      >
        Checking...
      </div>
    </div>
  </div>

  <script>
    const searchBtn = document.getElementById("searchBtn") as HTMLButtonElement;
    const searchQuery = document.getElementById("searchQuery") as HTMLInputElement;
    const results = document.getElementById("results") as HTMLDivElement;
    const envStatus = document.getElementById("envStatus") as HTMLDivElement;

    // Check environment on load
    async function checkEnv() {
      try {
        const res = await fetch("/api/mcp", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ tool: "" }), // Will trigger "Missing tool" error
        });
        const data = await res.json();

        if (data.error === "Missing tool parameter") {
          envStatus.innerHTML = "✅ MCP endpoint is configured and reachable";
          envStatus.style.background = "#d4edda";
          envStatus.style.borderColor = "#c3e6cb";
        } else if (data.error === "MCP endpoint not configured") {
          envStatus.innerHTML = "❌ STOREFRONT_MCP_ENDPOINT environment variable is not set";
          envStatus.style.background = "#f8d7da";
          envStatus.style.borderColor = "#f5c6cb";
        }
      } catch (e: any) {
        envStatus.innerHTML = `❌ Error: ${e.message}`;
        envStatus.style.background = "#f8d7da";
        envStatus.style.borderColor = "#f5c6cb";
      }
    }

    searchBtn.addEventListener("click", async () => {
      const query = searchQuery.value.trim();
      if (!query) {
        results.textContent = "Please enter a search query";
        return;
      }

      searchBtn.disabled = true;
      searchBtn.textContent = "Searching...";
      results.textContent = "Loading...";

      try {
        const res = await fetch("/api/mcp", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            tool: "search_shop_catalog",
            args: {
              query,
              context: `User is searching for: ${query}`,
              first: 5
            },
          }),
        });

        const data = await res.json();

        if (!res.ok) {
          results.textContent = `Error ${res.status}:\n${JSON.stringify(data, null, 2)}`;
          results.style.background = "#f8d7da";
          results.style.borderColor = "#f5c6cb";
        } else {
          results.textContent = JSON.stringify(data, null, 2);
          results.style.background = "#d4edda";
          results.style.borderColor = "#c3e6cb";
        }
      } catch (e: any) {
        results.textContent = `Exception:\n${e.message}`;
        results.style.background = "#f8d7da";
        results.style.borderColor = "#f5c6cb";
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = "Search";
      }
    });

    checkEnv();
  </script>
</Layout>
